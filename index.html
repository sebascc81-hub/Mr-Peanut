<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos Mr. Peanut</title>
    <style>
        /* --- ESTILO VISUAL: KRAFT Y SELLO --- */
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f0e6d2; /* Fondo Kraft */
            color: #2c2c2c; /* Color Tinta Negra */
        }

        .container { 
            background: #fffdf5; /* Papel claro */
            padding: 25px; 
            border: 2px solid #2c2c2c; /* Marco tipo sello */
            box-shadow: 5px 5px 0px rgba(44, 44, 44, 0.1); /* Sombra dura */
        }

        /* Cabecera y Logo */
        .logo-area { text-align: center; margin-bottom: 20px; }
        .logo-placeholder { font-size: 50px; } 

        h1 { 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            border-bottom: 2px solid #2c2c2c;
            padding-bottom: 10px;
            margin: 0 0 20px 0;
            font-size: 1.8em;
        }

        /* T√≠tulos de secci√≥n */
        .section-title { 
            background-color: #2c2c2c;
            color: #f0e6d2;
            padding: 5px 10px;
            margin-top: 25px; 
            margin-bottom: 15px; 
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
            display: inline-block;
        }

        /* Formulario */
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9em; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 1px solid #2c2c2c; 
            border-radius: 0; /* Bordes rectos */
            box-sizing: border-box; 
            font-size: 16px; 
            background-color: #fff;
        }

        /* Botones */
        button { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #2c2c2c; 
            font-size: 16px; 
            cursor: pointer; 
            font-weight: bold; 
            text-transform: uppercase; 
            margin-top: 15px; 
            transition: 0.2s;
        }
        
        .btn-add { background-color: #fff; color: #2c2c2c; } 
        .btn-add:hover { background-color: #2c2c2c; color: #fff; }
        
        .btn-send { background-color: #2c2c2c; color: #fff; margin-top: 30px; }
        .btn-send:hover { opacity: 0.9; }
        .btn-send:disabled { background-color: #999; border-color: #999; cursor: not-allowed; }

        /* Carrito */
        #cart-container { margin-top: 25px; border: 2px solid #2c2c2c; background: white; display: none; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #eee; color: #2c2c2c; text-align: left; padding: 10px; font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid #2c2c2c;}
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95em; vertical-align: middle; }
        .total-row { font-weight: bold; background-color: #f0e6d2; color: #2c2c2c; border-top: 2px solid #2c2c2c; }
        .delete-btn { color: #c0392b; cursor: pointer; font-weight: bold; text-align: center; font-size: 1.2em;}

        /* ETIQUETAS DE COLORES (BADGES) */
        .tag {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 2px;
            color: white;
            font-size: 0.7em;
            margin-right: 6px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .tag-blue { background-color: #2980b9; } /* Azul Man√≠ Salado */
        .tag-wine { background-color: #800020; } /* Vinotinto Man√≠ Dulce */
        .tag-green { background-color: #27ae60; } /* Verde Mix */

    </style>
</head>
<body>

<div class="container">
    
    <div class="logo-area">
        <div class="logo-placeholder">ü•ú</div>
        <h1>Mr. Peanut</h1>
        <div style="font-size: 0.9em; font-style: italic;">Calidad Artesanal</div>
    </div>
    
    <div class="section-title">1. Tus Datos</div>
    
    <label>Nombre del Cliente / Negocio</label>
    <input type="text" id="cliente" placeholder="Ej: Tienda La Esquina">
    
    <label>Persona de Contacto</label>
    <input type="text" id="contacto" placeholder="Ej: Juan P√©rez">
    
    <label>Tel√©fono / WhatsApp</label>
    <input type="tel" id="telefono" placeholder="Ej: 300 123 4567">
    
    <label>Direcci√≥n de Entrega</label>
    <input type="text" id="direccion" placeholder="Direcci√≥n completa">

    <div class="section-title">2. Arma tu pedido</div>
    
    <label>Producto</label>
    <select id="producto">
        <option value="">Cargando men√∫...</option>
    </select>

    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;">
            <label>Cantidad</label>
            <input type="number" id="cantidad" value="1" min="1">
        </div>
        <div style="flex: 1; display: flex; align-items: flex-end;">
            <div id="priceDisplay" style="font-weight: bold; margin-bottom: 12px; width: 100%; text-align: right; font-size: 1.2em;">$0</div>
        </div>
    </div>

    <button class="btn-add" onclick="agregarAlCarrito()">+ Agregar al Pedido</button>

    <div id="cart-container">
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cart-body"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2">TOTAL A PAGAR:</td>
                    <td id="grand-total">$0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <button class="btn-send" id="btnEnviar" onclick="enviarPedido()" disabled>FINALIZAR PEDIDO</button>
</div>

<script>
    // ----------------------------------------------------
    // CONEXI√ìN CON GOOGLE SHEETS
    // ----------------------------------------------------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLyAAHFE7zQLIAOfvVcX54gWR7nk900i4BI39esZJ-VZ2cTuEWxRnL-57c4807a3D3pA/exec"; 

    let catalogoPrecios = {};
    let carrito = [];

    // Cargar men√∫ al iniciar
    window.onload = function() {
        fetch(SCRIPT_URL)
        .then(response => response.json())
        .then(productos => {
            const select = document.getElementById('producto');
            select.innerHTML = '<option value="">Selecciona un producto...</option>';
            productos.forEach(p => {
                let option = document.createElement('option');
                option.value = p.nombre;
                option.text = `${p.nombre} - $${p.precio.toLocaleString()}`; 
                catalogoPrecios[p.nombre] = p.precio;
                select.add(option);
            });
        })
        .catch(error => {
            console.error('Error cargando men√∫:', error);
            document.getElementById('producto').innerHTML = '<option>Error cargando men√∫</option>';
        });
    };

    // Actualizar precio visual en tiempo real
    function actualizarPrecioUnitario() {
        const nombre = document.getElementById('producto').value;
        const cant = document.getElementById('cantidad').value;
        const precio = catalogoPrecios[nombre] || 0;
        document.getElementById('priceDisplay').innerText = `$${(precio * cant).toLocaleString()}`;
    }
    document.getElementById('producto').addEventListener('change', actualizarPrecioUnitario);
    document.getElementById('cantidad').addEventListener('input', actualizarPrecioUnitario);

    // AGREGAR AL CARRITO
    function agregarAlCarrito() {
        const nombre = document.getElementById('producto').value;
        const cantidad = parseInt(document.getElementById('cantidad').value);

        if (!nombre || cantidad < 1) {
            alert("Por favor selecciona un producto y una cantidad v√°lida.");
            return;
        }

        const precioUnit = catalogoPrecios[nombre];
        const precioTotal = precioUnit * cantidad;

        // A√±adir al array del carrito
        carrito.push({
            producto: nombre,
            cantidad: cantidad,
            precioUnitario: precioUnit,
            precioTotal: precioTotal
        });

        actualizarTablaCarrito();
        
        // Resetear campos de producto para seguir agregando
        document.getElementById('producto').value = "";
        document.getElementById('cantidad').value = 1;
        document.getElementById('priceDisplay').innerText = "$0";
    }

    // DIBUJAR TABLA (Con l√≥gica de colores de marca)
    function actualizarTablaCarrito() {
        const tbody = document.getElementById('cart-body');
        tbody.innerHTML = "";
        let granTotal = 0;

        carrito.forEach((item, index) => {
            granTotal += item.precioTotal;

            // --- L√ìGICA DE ETIQUETAS DE COLOR ---
            let badge = "";
            let nombreLower = item.producto.toLowerCase();

            if(nombreLower.includes("salado")) {
                badge = '<span class="tag tag-blue">SALADO</span>';
            } else if(nombreLower.includes("dulce")) {
                badge = '<span class="tag tag-wine">DULCE</span>';
            } else if(nombreLower.includes("mix") || nombreLower.includes("mixto")) {
                badge = '<span class="tag tag-green">MIX</span>';
            }
            // ------------------------------------

            let row = `<tr>
                <td>${badge} ${item.producto}</td>
                <td style="text-align: center;">${item.cantidad}</td>
                <td>$${item.precioTotal.toLocaleString()}</td>
                <td class="delete-btn" onclick="eliminarItem(${index})">√ó</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('grand-total').innerText = `$${granTotal.toLocaleString()}`;
        
        // Mostrar u ocultar tabla y bot√≥n enviar
        const container = document.getElementById('cart-container');
        const btnEnviar = document.getElementById('btnEnviar');
        
        if (carrito.length > 0) {
            container.style.display = "block";
            btnEnviar.disabled = false;
            btnEnviar.innerText = `CONFIRMAR PEDIDO ($${granTotal.toLocaleString()})`;
        } else {
            container.style.display = "none";
            btnEnviar.disabled = true;
            btnEnviar.innerText = "FINALIZAR PEDIDO";
        }
    }

    // ELIMINAR ITEM
    function eliminarItem(index) {
        carrito.splice(index, 1);
        actualizarTablaCarrito();
    }

    // ENVIAR TODO A GOOGLE SHEETS
    function enviarPedido() {
        // Validar datos cliente
        const cliente = document.getElementById('cliente').value;
        const telefono = document.getElementById('telefono').value;
        const direccion = document.getElementById('direccion').value;
        const contacto = document.getElementById('contacto').value;

        if (!cliente || !telefono || !direccion) {
            alert("‚ö†Ô∏è Faltan datos: Por favor completa Nombre, Tel√©fono y Direcci√≥n.");
            return;
        }

        const btn = document.getElementById('btnEnviar');
        const textoOriginal = btn.innerText;
        btn.innerText = "ENVIANDO...";
        btn.disabled = true;

        const ordenCompleta = {
            cliente: cliente,
            telefono: telefono,
            direccion: direccion,
            contacto: contacto,
            carrito: carrito
        };

        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(ordenCompleta)
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === "Exito"){
                alert("‚úÖ ¬°Pedido recibido! Gracias por elegir Mr. Peanut.");
                carrito = []; // Limpiar carrito
                actualizarTablaCarrito();
                // Limpiar formulario
                document.getElementById('cliente').value = "";
                document.getElementById('telefono').value = "";
                document.getElementById('direccion').value = "";
                document.getElementById('contacto').value = "";
            } else {
                alert("‚ùå Error en el servidor: " + data.error);
            }
            btn.innerText = textoOriginal;
            btn.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert("‚ùå Error de conexi√≥n. Intenta nuevamente.");
            btn.innerText = textoOriginal;
            btn.disabled = false;
        });
    }
</script>

</body>
</html>